# Chrome 拡張機能：煩悩 OFF - 画像を仏像に切り替え

ウェブページ内の画像を仏像画像に切り替えて、煩悩を断つ Chrome 拡張機能です。

## 🙏 機能

### **画像置換機能**

- **20 枚の仏像画像**: ランダムに選択・ランダムクロップで表示
- **多様な要素対応**: img、picture、source、background-image、iframe
- **除外機能**: SVG・GIF・37px 以下の小画像は除外
- **高品質処理**: アスペクト比維持、Canvas 処理

### **操作方法**

- **フローティングボタン**: 右上の「煩悩 ON/OFF」ボタンで切り替え
- **拡張機能ポップアップ**: 従来の画像切り替えボタン
- **設定画面**: 機能の有効/無効を永続化

### **パフォーマンス最適化**

- **LRU キャッシュ**: 最大 50 個の画像キャッシュで高速処理
- **DOM 走査最適化**: 特定要素のみをターゲット
- **メモリ効率**: WeakMap と LRU キャッシュでメモリリーク防止

## 📦 Chrome 拡張機能のインストール手順

### 1. Chrome 拡張機能の開発者モードを有効にする

1. **Chrome ブラウザを開く**
2. **アドレスバーに以下を入力して Enter キー**
   ```
   chrome://extensions/
   ```
3. **右上の「開発者モード」トグルを ON にする**
   - ページ右上にあるスイッチをクリックして青色にする

### 2. 拡張機能を読み込む

1. **「パッケージ化されていない拡張機能を読み込む」ボタンをクリック**
   - 開発者モードを有効にすると表示されるボタン
2. **ファイル選択ダイアログで`chrome-extension`フォルダを選択**
   - このプロジェクトの`chrome-extension`フォルダを選択
3. **「選択」ボタンをクリック**
4. **拡張機能が読み込まれ、ツールバーにアイコンが表示される**

### 3. 拡張機能の確認

- Chrome 拡張機能ページに「煩悩 OFF」が表示される
- ブラウザのツールバー（アドレスバー右側）にアイコンが表示される
- アイコンが見えない場合は、パズルピースアイコンをクリックして拡張機能一覧から選択

## 🚀 使用方法

### 1. 機能を有効にする

1. **拡張機能アイコンをクリック**
2. **「設定を開く」ボタンをクリック**
3. **設定画面で「機能を有効にする」をチェック**
4. **右上にフローティングボタンが表示される**

### 2. 画像を仏像に切り替える

#### **方法 1: フローティングボタン（推奨）**

1. **右上の「煩悩 OFF」ボタンをクリック**
2. **ページ内の画像が仏像画像に変わる**
3. **「煩悩 ON」ボタンをクリックして元に戻す**

#### **方法 2: 拡張機能ポップアップ**

1. **ツールバーの拡張機能アイコンをクリック**
2. **「画像を切り替え」ボタンをクリック**
3. **ページ内の画像が仏像画像に変わる**

### 3. テストページで確認

1. **`test-page.html`をブラウザで開く**
   - ファイルをダブルクリック、または
   - ブラウザにファイルをドラッグ&ドロップ
2. **または任意の Web ページ（画像が含まれるページ）を開く**

## 📁 ファイル構成

```
chrome-extension/
├── manifest.json          # 拡張機能の設定ファイル
├── content.js            # メイン機能のスクリプト（最適化済み）
├── popup.html            # ポップアップのUI
├── popup.js              # ポップアップの制御
├── settings.html         # 設定画面のUI
├── settings.js           # 設定画面の制御
├── icons/                # 拡張機能のアイコン
│   ├── icon.svg
│   ├── icon16.png
│   ├── icon48.png
│   └── icon128.png
└── image/                # 仏像画像（20枚、最適化済み）
    ├── 1.jpg
    ├── 2.jpg
    ├── ...
    └── 20.jpg

test-page.html             # テスト用ページ
test-iframe.html           # iframe テスト用ページ
README.md                  # このファイル
```

## 🔧 技術仕様

### **基本仕様**

- **Manifest Version**: 3
- **対象要素**: img、picture、source、background-image、iframe
- **除外対象**: SVG 画像、GIF 画像、37px 以下の小画像
- **画像処理**: Canvas API で動的生成・ランダムクロップ

### **パフォーマンス**

- **LRU キャッシュ**: 最大 50 個の画像キャッシュ
- **DOM 走査最適化**: 特定要素のみをターゲット（約 70-80%削減）
- **メモリ管理**: WeakMap と LRU キャッシュの組み合わせ

### **画像最適化**

- **総サイズ**: 1.9MB（20 枚の仏像画像）
- **品質**: JPEG 60%品質で最適化済み
- **サイズ範囲**: 40KB〜155KB

### **ランダム処理**

- **画像選択**: 20 枚からランダム選択
- **クロップ処理**:
  - 横長画像: 完全ランダム位置
  - 縦長画像: 上端・中央・下端の 3 種類からランダム選択

## 🛠️ トラブルシューティング

### 拡張機能が表示されない場合

1. **Chrome 拡張機能ページ（chrome://extensions/）で確認**

   - 拡張機能が有効になっているか確認
   - エラーメッセージが表示されていないか確認

2. **ツールバーにアイコンが見えない場合**
   - ツールバー右端のパズルピースアイコンをクリック
   - 拡張機能一覧から「煩悩 OFF」を探す
   - ピンアイコンをクリックしてツールバーに固定

### フローティングボタンが表示されない場合

1. **設定画面で機能を有効にする**

   - 拡張機能アイコン → 「設定を開く」
   - 「機能を有効にする」をチェック

2. **ページをリロード**
   - F5 キーでページをリロード

### 画像が切り替わらない場合

1. **対象外の画像の可能性**

   - SVG 画像・GIF 画像は対象外
   - 37px 以下の小さなアイコンは対象外

2. **picture 要素の問題**

   - 初回処理で問題が発生した場合
   - 一度「煩悩 ON」→「煩悩 OFF」で正常動作

3. **ページのリロード**
   - ページをリロード（F5 キー）してから再試行

### エラーが発生する場合

1. **開発者ツールでエラー確認**

   - F12 キーで開発者ツールを開く
   - Console タブでエラーメッセージを確認

2. **拡張機能の再読み込み**
   - Chrome 拡張機能ページで「再読み込み」ボタンをクリック

## 🎯 開発履歴

### v2.0.0 - 最適化版

- **LRU キャッシュ実装**: メモリ効率 30%向上
- **DOM 走査最適化**: パフォーマンス 50%向上
- **コードリファクタリング**: 保守性大幅向上

### v1.5.0 - 多機能対応版

- **20 枚の仏像画像**: ランダム選択・クロップ
- **picture 要素対応**: source 要素も正しく処理
- **設定画面追加**: 機能 ON/OFF 永続化

### v1.0.0 - 初期版

- **基本機能**: 画像を仏像に切り替え
- **フローティングボタン**: 右上に操作ボタン
- **除外機能**: SVG・小画像の除外

## 📄 ライセンス

このプロジェクトは MIT ライセンスの下で公開されています。

---

**南無阿弥陀仏** 🙏
